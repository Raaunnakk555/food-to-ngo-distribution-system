<!DOCTYPE html>
<html>
<head>
  <title>Restaurant Dashboard</title>
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/restaurant.css">
</head>

<body>
<div class="floating-icons">
  <span style="left:10%">üçï</span>
  <span style="left:25%">üçî</span>
  <span style="left:45%">üçú</span>
  <span style="left:65%">ü•ó</span>
  <span style="left:85%">üçΩÔ∏è</span>
</div>

<div class="topbar">
  <h2>Restaurant Dashboard</h2>
  <button onclick="logout()">Logout</button>
</div>
<div class="card">
  <h3 id="restName"></h3>

  <a href="restaurant-menu.html">
    <button>Manage Permanent Menu</button>
  </a>
</div>

<div class="card">
  <h3>Your Menu (Set Surplus Quantity)</h3>
  <div id="menu"></div>
</div>

<div class="card">
  <h3>Live Summary</h3>

  <p>
    Total Plates:
    <b id="totalPlates">0</b>
  </p>

  <p>
    Total SMU:
    <b id="totalSMU">0</b>
  </p>

  <button onclick="publishSurplus()">
    Publish Daily Surplus
  </button>

  <button onclick="resetSurplus()">
    Reset Today
  </button>
</div>

<div class="card">
  <h3>Today's Surplus Summary</h3>
  <div id="summary"></div>
</div>

<div class="card">
  <h3>Incoming Orders</h3>
  <div id="restaurantOrders"></div>
</div>

<script src="js/auth.js"></script>

<script>

const user = JSON.parse(localStorage.getItem("user"));

if (!user || user.role !== "restaurant") {
  alert("Login required!");
  window.location.replace("restaurant-login.html");
}
document.getElementById("restName").innerText =
  `Welcome, ${user.restaurantName}`;

const menuDiv = document.getElementById("menu");

function updateLiveSummary() {
  let plates = 0;
  let smu = 0;

  user.menu.forEach(item => {
    plates += item.quantity || 0;
    smu += (item.quantity || 0) * item.smu;
  });

  document.getElementById("totalPlates").innerText = plates;
  document.getElementById("totalSMU").innerText = smu.toFixed(2);
}

function renderMenu() {

  menuDiv.innerHTML = "";

  if (!user.menu || user.menu.length === 0) {
    menuDiv.innerHTML = "<p>No menu items yet.</p>";
    return;
  }

  user.menu.forEach((item, index) => {

    if (!item.quantity) item.quantity = 0;

    const div = document.createElement("div");

    div.className = "card";

    div.innerHTML = `
      <strong>${item.name}</strong>
      (${item.category}, ${item.veg})
      <br>
      Calories: ${item.calories}
      | SMU: ${item.smu}
      | Shelf Life: ${item.shelfLife} hrs
      <br><br>
      Quantity:
      <button onclick="changeQty(${index}, -1)">-</button>
      <span>${item.quantity}</span>
      <button onclick="changeQty(${index}, 1)">+</button>
    `;

    menuDiv.appendChild(div);
  });

  updateLiveSummary();
}

function changeQty(index, delta) {

  user.menu[index].quantity += delta;

  if (user.menu[index].quantity < 0)
    user.menu[index].quantity = 0;

  saveRestaurantMenu(user.username, user.menu);
  localStorage.setItem("user", JSON.stringify(user));

  renderMenu();
}

function publishSurplus() {

  const users = getUsers();
  const index = users.findIndex(
    u => u.username === user.username
  );

  if (index === -1) {
    alert("Restaurant not found!");
    return;
  }

  let totalSMU = 0;
  let totalItems = 0;

  users[index].menu.forEach(item => {

    if (item.quantity > 0) {

      item.status = "Published";
      item.publishedTime = Date.now();

      totalSMU += item.smu * item.quantity;
      totalItems += item.quantity;
    }

  });


  saveUsers(users);


  localStorage.setItem(
    "user",
    JSON.stringify(users[index])
  );


  buildSurplusData();

  console.log(
    "New surplus:",
    JSON.parse(localStorage.getItem("allSurplus"))
  );

  document.getElementById("summary").innerHTML = `
    Total Plates Donated: <b>${totalItems}</b><br>
    Total SMU Contributed: <b>${totalSMU.toFixed(2)}</b>
  `;

  alert("Daily surplus published!");
}



function resetSurplus() {

  user.menu.forEach(item => {
    item.quantity = 0;
    delete item.publishedDate;
  });

  saveRestaurantMenu(user.username, user.menu);
  localStorage.setItem("user", JSON.stringify(user));

  document.getElementById("summary").innerHTML = "";
  updateLiveSummary();

  alert("Surplus reset for today.");
  renderMenu();
}

function logout() {
  localStorage.removeItem("user");
  window.location.replace("restaurant-login.html");
}

renderMenu();

</script>

<script src="js/restaurant-orders.js"></script>

</body>
</html>
